/**
 * SocializerForm - Formulario para crear/editar socializadores
 */

import { useEffect, useState, useCallback } from 'react'
import { useForm } from 'react-hook-form'
import type { RoleOption } from '../types'
import { SocializerFormData } from '../models/FormData'
import { apiService } from '../services/api.service'
import { useAuth } from '../contexts/AuthContext'
import type { SocializerFormProps } from './types'
import { Input, Select } from './index'
import { translateRole } from '../utils'
import { getHierarchyConfig, getVisibleFieldsForRole, getAutoSelectField } from '../constants/hierarchyConfig'
import '../styles/SurveyForm.scss'

interface CoordinatorData {
  _id: string
  fullName: string
  idNumber?: string
  phone?: string
  status?: string
  user?: {
    _id: string
    email?: string
    [key: string]: unknown
  }
  profile?: {
    _id: string
    fullName?: string
    [key: string]: unknown
  }
  email?: string
}

export function SocializerForm({
  onSubmit,
  isLoading = false,
  error,
  initialData,
  isEditMode = false,
}: SocializerFormProps) {
  const { user } = useAuth()
  const userRole = user?.role?.role?.toLowerCase() || ''
  const [roles, setRoles] = useState<RoleOption[]>([])
  const [loadingRoles, setLoadingRoles] = useState(true)
  const [coordinators, setCoordinators] = useState<CoordinatorData[]>([])
  const [fieldCoordinators, setFieldCoordinators] = useState<CoordinatorData[]>([])
  const [zoneCoordinators, setZoneCoordinators] = useState<CoordinatorData[]>([])
  const [loadingCoordinators, setLoadingCoordinators] = useState(false)
  const [selectedRole, setSelectedRole] = useState<string>('')

  const {
    register,
    handleSubmit,
    formState: { errors },
    reset,
    watch,
    setValue,
  } = useForm<ReturnType<SocializerFormData['toFormData']>>({
    mode: 'onBlur',
    defaultValues: initialData || new SocializerFormData().toFormData(),
  })

  // Helper para obtener email de la nueva estructura de API
  const getCoordinatorEmail = (item: CoordinatorData): string => {
    return item.user?.email || item.email || ''
  }

  // Helper para obtener fullName de la nueva estructura de API
  const getCoordinatorFullName = (item: CoordinatorData): string => {
    return item.fullName || item.user?.fullName || ''
  }

  const loadHierarchyOptions = useCallback(async (role: string, parentCoordinatorId?: string) => {
    try {
      const normalizedRole = role.toLowerCase()
      
      // Si no hay usuario logueado o no tiene profile, no cargar
      if (!user?.id) return

      if (normalizedRole === 'socializer' || normalizedRole === 'socializador') {
        setLoadingCoordinators(true)
        // Si hay un coordinador de campo seleccionado, filtrar supervisores por ese coordinador
        if (parentCoordinatorId) {
          const supervisors = await apiService.getSubordinatesByRole(parentCoordinatorId, 'supervisor')
          setCoordinators(supervisors)
        } else {
          // Si no hay coordinador de campo, usar el usuario logueado
          const supervisors = await apiService.getSubordinatesByRole(user.id, 'supervisor')
          setCoordinators(supervisors)
        }
        return
      }

      if (normalizedRole === 'supervisor') {
        setLoadingCoordinators(true)
        // Si hay un coordinador de zona seleccionado, filtrar coordinadores de campo por ese coordinador
        if (parentCoordinatorId) {
          const fieldCoords = await apiService.getSubordinatesByRole(parentCoordinatorId, 'fieldcoordinator')
          setFieldCoordinators(fieldCoords)
        } else {
          // Si no hay coordinador de zona, usar el usuario logueado
          const fieldCoords = await apiService.getSubordinatesByRole(user.id, 'fieldcoordinator')
          setFieldCoordinators(fieldCoords)
        }
        return
      }

      if (normalizedRole === 'fieldcoordinator' || normalizedRole === 'coordinador de campo') {
        if (zoneCoordinators.length > 0) return
        setLoadingCoordinators(true)
        // Usar endpoint con jerarquía para obtener solo coordinadores de zona permitidos
        const zoneCoords = await apiService.getSubordinatesByRole(user.id, 'zonecoordinator')
        setZoneCoordinators(zoneCoords)
        return
      }

      return
    } catch {
      // Error silencioso
    } finally {
      setLoadingCoordinators(false)
    }
  }, [user?.id, zoneCoordinators.length])

  // Watch role changes to show/hide coordinator field
  const watchedRoleId = watch('roleId')
  const watchedFieldCoordinator = watch('assignedFieldCoordinator')
  const watchedZoneCoordinator = watch('assignedZoneCoordinator')

  // Actualizar valores del formulario cuando cambien los datos iniciales
  useEffect(() => {
    if (initialData) {
      reset(initialData)
    }
  }, [initialData, reset])

  // Auto-seleccionar coordinador cuando el usuario es supervisor o fieldcoordinator
  useEffect(() => {
    if (!isEditMode && !initialData) {
      if (userRole === 'fieldcoordinator' && user?.id) {
        setValue('assignedFieldCoordinator', user.id)
      }
    }
  }, [userRole, user?.id, isEditMode, initialData, setValue])

  // Auto-seleccionar el campo según la configuración del rol
  useEffect(() => {
    if (!isEditMode && !initialData && userRole && user?.profile?._id) {
      const autoSelectField = getAutoSelectField(userRole)
      
      if (autoSelectField === 'assignedZoneCoordinator') {
        setValue('assignedZoneCoordinator', user.profile._id)
      } else if (autoSelectField === 'assignedFieldCoordinator') {
        setValue('assignedFieldCoordinator', user.profile._id)
      } else if (autoSelectField === 'assignedSupervisor') {
        // Para supervisor, necesita encontrarse en la lista de supervisores
        if (coordinators.length > 0) {
          const currentSupervisor = coordinators.find(s => {
            const supervisorUserId = typeof s.user === 'string' ? s.user : s.user?._id
            return supervisorUserId === user.id
          })
          if (currentSupervisor) {
            setValue('assignedSupervisor', currentSupervisor._id)
          }
        }
      }
    }
  }, [userRole, user?.profile?._id, user?.id, isEditMode, initialData, setValue, coordinators])

  // Update selectedRole when roleId changes
  useEffect(() => {
    if (watchedRoleId) {
      const role = roles.find(r => r._id === watchedRoleId)
      const roleValue = role?.originalRole || role?.role || ''
      setSelectedRole(roleValue)
      
      // Si el usuario es supervisor y el rol es socializador, cargar supervisores
      if (userRole === 'supervisor' && (roleValue === 'socializer' || roleValue === 'socializador')) {
        loadHierarchyOptions(roleValue)
      }
    }
  }, [watchedRoleId, roles, userRole, loadHierarchyOptions])

  useEffect(() => {
    loadRoles()
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [])

  // Auto-seleccionar rol según la configuración del usuario
  useEffect(() => {
    if (!isEditMode && !initialData && userRole === 'supervisor' && roles.length > 0) {
      // Supervisor solo puede crear socializadores
      const socializerRole = roles.find(r => 
        r.originalRole === 'socializer' || r.originalRole === 'socializador'
      )
      if (socializerRole) {
        setValue('roleId', socializerRole._id)
      }
    }
  }, [roles, userRole, isEditMode, initialData, setValue])

  const loadHierarchyOptions = useCallback(async (role: string, parentCoordinatorId?: string) => {
    try {
      const normalizedRole = role.toLowerCase()
      
      // Si no hay usuario logueado o no tiene profile, no cargar
      if (!user?.id) return

      if (normalizedRole === 'socializer' || normalizedRole === 'socializador') {
        setLoadingCoordinators(true)
        // Si hay un coordinador de campo seleccionado, filtrar supervisores por ese coordinador
        if (parentCoordinatorId) {
          const supervisors = await apiService.getSubordinatesByRole(parentCoordinatorId, 'supervisor')
          setCoordinators(supervisors)
        } else {
          // Si no hay coordinador de campo, usar el usuario logueado
          const supervisors = await apiService.getSubordinatesByRole(user.id, 'supervisor')
          setCoordinators(supervisors)
        }
        return
      }

      if (normalizedRole === 'supervisor') {
        setLoadingCoordinators(true)
        // Si hay un coordinador de zona seleccionado, filtrar coordinadores de campo por ese coordinador
        if (parentCoordinatorId) {
          const fieldCoords = await apiService.getSubordinatesByRole(parentCoordinatorId, 'fieldcoordinator')
          setFieldCoordinators(fieldCoords)
        } else {
          // Si no hay coordinador de zona, usar el usuario logueado
          const fieldCoords = await apiService.getSubordinatesByRole(user.id, 'fieldcoordinator')
          setFieldCoordinators(fieldCoords)
        }
        return
      }

      if (normalizedRole === 'fieldcoordinator' || normalizedRole === 'coordinador de campo') {
        if (zoneCoordinators.length > 0) return
        setLoadingCoordinators(true)
        // Usar endpoint con jerarquía para obtener solo coordinadores de zona permitidos
        const zoneCoords = await apiService.getSubordinatesByRole(user.id, 'zonecoordinator')
        setZoneCoordinators(zoneCoords)
        return
      }

      return
    } catch {
      // Error silencioso
    } finally {
      setLoadingCoordinators(false)
    }
  }, [user?.id, zoneCoordinators.length])

  useEffect(() => {
    if (!selectedRole) return
    loadHierarchyOptions(selectedRole)
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [selectedRole])

  // Recargar supervisores cuando cambie el coordinador de campo seleccionado
  useEffect(() => {
    const normalizedRole = selectedRole.toLowerCase()
    if ((normalizedRole === 'socializer' || normalizedRole === 'socializador') && watchedFieldCoordinator) {
      // Limpiar selección de supervisor actual
      setValue('assignedSupervisor', '')
      // Recargar supervisores filtrados por el coordinador de campo
      loadHierarchyOptions(selectedRole, watchedFieldCoordinator)
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [watchedFieldCoordinator])

  // Recargar coordinadores de campo cuando cambie el coordinador de zona seleccionado
  useEffect(() => {
    const normalizedRole = selectedRole.toLowerCase()
    if (normalizedRole === 'supervisor' && watchedZoneCoordinator) {
      // Limpiar selección de coordinador de campo actual
      setValue('assignedFieldCoordinator', '')
      // Limpiar supervisores también
      setValue('assignedSupervisor', '')
      setCoordinators([])
      // Recargar coordinadores de campo filtrados por el coordinador de zona
      loadHierarchyOptions(selectedRole, watchedZoneCoordinator)
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [watchedZoneCoordinator])

  const loadRoles = async () => {
    try {
      const response = await apiService.getRoles()
      // Usar el método helper de la clase GetRolesResponse
      let activeRoles = response.getActiveRoles()
      
      // Filtrar roles según jerarquía usando la configuración
      const hierarchyConfig = getHierarchyConfig(userRole)
      
      // Usar creatableRoles de la configuración para filtrar
      if (hierarchyConfig.creatableRoles && hierarchyConfig.creatableRoles.length > 0) {
        activeRoles = activeRoles.filter(role => 
          hierarchyConfig.creatableRoles!.includes(role.role.toLowerCase())
        )
      }
      // Si no tiene creatableRoles definidos, no puede crear nada (como readonly)
      
      // Traducir roles sin filtrar ni limitar la cantidad
      const translatedRoles = activeRoles.map(role => ({
        _id: role._id,
        role: translateRole(role.role),
        originalRole: role.role,
        status: role.status
      }))
      
      // Ordenar roles en el orden requerido: Administrador, Supervisor, Socializador, Solo Lectura
      const roleOrder = ['Administrador', 'Coordinador de Zona', 'Coordinador de Campo', 'Supervisor', 'Socializador', 'Solo Lectura']
      translatedRoles.sort((a, b) => {
        const indexA = roleOrder.indexOf(a.role)
        const indexB = roleOrder.indexOf(b.role)
        // Si no está en el orden, ponerlo al final
        if (indexA === -1) return 1
        if (indexB === -1) return -1
        return indexA - indexB
      })
      
      setRoles(translatedRoles)
    } catch {
      // Error silencioso
    } finally {
      setLoadingRoles(false)
    }
  }

  // Submit wrapper para transformar coordinatorId según jerarquía
  const handleFormSubmit = (formData: ReturnType<SocializerFormData['toFormData']>) => {
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    const payload: any = { ...formData }
    
    console.log('Form data before transform:', formData)
    
    const selectedRoleObj = roles.find(r => r._id === payload.roleId)
    const roleToCheck = selectedRoleObj?.originalRole?.toLowerCase() || selectedRoleObj?.role?.toLowerCase() || ''
    
    console.log('Role to check:', roleToCheck)
    console.log('User role:', userRole)
    console.log('Payload before mapping:', payload)
    
    // Agregar automáticamente el campo de coordinador según el rol del usuario logueado
    if (userRole === 'supervisor') {
      // El supervisor crea socializadores y debe asignarse automáticamente
      if (!payload.assignedSupervisor || payload.assignedSupervisor === '') {
        payload.assignedSupervisor = user?.profile?._id
        console.log('Auto-assigned supervisor (profile ID):', user?.profile?._id)
      }
    } else if (userRole === 'fieldcoordinator') {
      // El coordinador de campo crea supervisores y debe asignarse automáticamente
      if (!payload.assignedFieldCoordinator || payload.assignedFieldCoordinator === '') {
        payload.assignedFieldCoordinator = user?.profile?._id
        console.log('Auto-assigned fieldCoordinator (profile ID):', user?.profile?._id)
      }
    } else if (userRole === 'zonecoordinator') {
      // El coordinador de zona crea campos y debe asignarse automáticamente
      if (!payload.assignedZoneCoordinator || payload.assignedZoneCoordinator === '') {
        payload.assignedZoneCoordinator = user?.profile?._id
        console.log('Auto-assigned zoneCoordinator (profile ID):', user?.profile?._id)
      }
    }
    
    // Mapear el campo de asignación según el rol
    if (roleToCheck === 'socializer' || roleToCheck === 'socializador') {
      // Socializador -> asignar supervisor
      if (payload.assignedSupervisor) {
        console.log('Mapping assignedSupervisor:', payload.assignedSupervisor)
        payload.supervisorId = payload.assignedSupervisor
        delete payload.assignedSupervisor
      } else {
        console.warn('No assignedSupervisor found in payload!')
      }
    } else if (roleToCheck === 'supervisor') {
      // Supervisor -> asignar coordinador de campo
      if (payload.assignedFieldCoordinator) {
        console.log('Mapping assignedFieldCoordinator:', payload.assignedFieldCoordinator)
        payload.fieldCoordinatorId = payload.assignedFieldCoordinator
        delete payload.assignedFieldCoordinator
      }
    } else if (roleToCheck === 'fieldcoordinator') {
      // Coordinador de Campo -> asignar coordinador de zona
      if (payload.assignedZoneCoordinator) {
        console.log('Mapping assignedZoneCoordinator:', payload.assignedZoneCoordinator)
        payload.zoneCoordinatorId = payload.assignedZoneCoordinator
        delete payload.assignedZoneCoordinator
      }
    }
    
    // Eliminar campos no usados
    delete payload.coordinator
    delete payload.assignedFieldCoordinator
    delete payload.assignedSupervisor
    delete payload.assignedZoneCoordinator
    
    console.log('Final payload:', payload)
    onSubmit(payload)
  }

  return (
    <div className="survey-form">
      <div className="survey-form__container">
        <div className="survey-form__header">
          <h2 className="survey-form__title">
            {isEditMode ? 'Editar Usuario' : 'Nuevo Usuario'}
          </h2>
        </div>

        {error && (
          <div className="survey-form__error">
            <p>{error}</p>
          </div>
        )}

        <form className="survey-form__form" onSubmit={handleSubmit(handleFormSubmit)}>
          {/* Nombre completo */}
          <Input
            id="fullName"
            type="text"
            label="Nombre Completo"
            placeholder="Ingrese el nombre completo"
            disabled={isLoading}
            required
            error={errors.fullName?.message}
            {...register('fullName', {
              required: 'El nombre es obligatorio',
              minLength: {
                value: 3,
                message: 'El nombre debe tener al menos 3 caracteres',
              },
              setValueAs: (value) => value?.toUpperCase() || '',
            })}
          />

          {/* Número de identificación */}
          <Input
            id="idNumber"
            type="text"
            label="Número de Identificación"
            placeholder="1234567890"
            disabled={isLoading}
            required
            error={errors.idNumber?.message}
            {...register('idNumber', {
              required: 'El número de identificación es obligatorio',
              pattern: {
                value: /^[0-9]+$/,
                message: 'Solo se permiten números',
              },
            })}
          />

          {/* Teléfono */}
          <Input
            id="phone"
            type="tel"
            label="Teléfono"
            placeholder="3001234567"
            disabled={isLoading}
            required
            error={errors.phone?.message}
            {...register('phone', {
              required: 'El teléfono es obligatorio',
              pattern: {
                value: /^[0-9]{10}$/,
                message: 'El teléfono debe tener 10 dígitos',
              },
            })}
          />

          {/* Email */}
          <Input
            id="email"
            type="email"
            label="Email"
            placeholder="correo@ejemplo.com"
            disabled={isLoading}
            required
            error={errors.email?.message}
            {...register('email', {
              required: 'El email es obligatorio',
              pattern: {
                value: /^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}$/i,
                message: 'Email inválido',
              },
            })}
          />

          {/* Contraseña */}
          <Input
            id="password"
            type="password"
            label={`Contraseña ${isEditMode ? '(dejar vacío para no cambiar)' : ''}`}
            placeholder="Ingrese contraseña"
            disabled={isLoading}
            required={!isEditMode}
            error={errors.password?.message}
            {...register('password', {
              required: isEditMode ? false : 'La contraseña es obligatoria',
              minLength: {
                value: 6,
                message: 'La contraseña debe tener al menos 6 caracteres',
              },
            })}
          />

          {/* Rol */}
          <Select
            id="roleId"
            label="Rol"
            placeholder="Seleccione un rol"
            options={roles.map((role) => ({
              value: role._id,
              label: role.role,
            }))}
            disabled={isLoading || loadingRoles || (userRole === 'supervisor' && !isEditMode)}
            required
            error={errors.roleId?.message}
            {...register('roleId', {
              required: 'Debe seleccionar un rol',
            })}
          />
          {userRole === 'supervisor' && !isEditMode && (
            <span className="form-group__hint">
              El rol se asigna automáticamente como Socializador.
            </span>
          )}

          {/* Campos jerárquicos dinámicos según configuración */}
          {getVisibleFieldsForRole(userRole, selectedRole).map((hierarchyField) => {
            const isAutoSelected = getAutoSelectField(userRole) === hierarchyField.fieldKey
            const dataSource = hierarchyField.dataSourceField === 'zoneCoordinators' 
              ? zoneCoordinators 
              : hierarchyField.dataSourceField === 'fieldCoordinators' 
              ? fieldCoordinators 
              : coordinators

            return (
              <div key={hierarchyField.fieldKey}>
                <Select
                  id={hierarchyField.fieldKey}
                  label={hierarchyField.label}
                  placeholder={`Seleccione un ${hierarchyField.label.toLowerCase()}`}
                  options={dataSource.map((item) => ({
                    value: item._id,
                    label: `${getCoordinatorFullName(item)} - ${getCoordinatorEmail(item)}`,
                  }))}
                  disabled={isLoading || isAutoSelected}
                  required
                  error={errors[hierarchyField.fieldKey as keyof typeof errors]?.message}
                  // eslint-disable-next-line @typescript-eslint/no-explicit-any
                  {...register(hierarchyField.fieldKey as any, {
                    required: `Debe seleccionar un ${hierarchyField.label.toLowerCase()}`,
                  })}
                />
                {dataSource.length === 0 && !loadingCoordinators && (
                  <span className="form-group__hint">
                    No hay {hierarchyField.label.toLowerCase()}s disponibles. Por favor, cree uno primero.
                  </span>
                )}
                {isAutoSelected && (
                  <span className="form-group__hint">
                    Este campo se rellena automáticamente con tu {hierarchyField.label.toLowerCase()} actual.
                  </span>
                )}
              </div>
            )
          })}

          {/* Estado */}
          <Select
            id="status"
            label="Estado"
            options={[
              { value: 'enabled', label: 'Habilitado' },
              { value: 'disabled', label: 'Deshabilitado' },
            ]}
            disabled={isLoading}
            {...register('status')}
          />

          {/* Botones */}
          <div className="form-group form-group--actions">
            <button
              type="submit"
              className="btn btn--primary"
              disabled={isLoading || loadingRoles}
            >
              {isLoading ? 'Guardando...' : isEditMode ? 'Actualizar' : 'Crear Usuario'}
            </button>
          </div>
        </form>
      </div>
    </div>
  )
}
